<!--pages/training/cardio.wxml-->
<view class="container">
  <!-- è¿åŠ¨ä¿¡æ¯å¤´éƒ¨ -->
  <view class="training-header">
    <view class="training-title">{{exercise.name}}</view>
    <view class="training-desc">{{isRunning ? 'æ­£åœ¨è¿›è¡Œä¸­' : 'å‡†å¤‡å¼€å§‹è¿åŠ¨'}}</view>
    <view class="header-actions">
      <view class="voice-settings" bindtap="showVoiceSettings">
        <text class="icon-text">ğŸ”Š</text>
        <text>{{voiceSettings.enabled ? voiceSettings.interval + 'åˆ†é’Ÿ' : 'å·²å…³é—­'}}</text>
      </view>
      
      <!-- æ·»åŠ GPSä¿¡å·è´¨é‡æŒ‡ç¤ºå™¨ -->
      <view class="gps-quality {{gpsQuality.signal}}">
        <text class="icon-text">ğŸ“</text>
        <text>GPS: {{gpsQuality.signal === 'good' ? 'è‰¯å¥½' : gpsQuality.signal === 'moderate' ? 'ä¸€èˆ¬' : 'è¾ƒå¼±'}}</text>
      </view>
    </view>
  </view>

  <!-- åœ°å›¾ç»„ä»¶ - ç§»åˆ°å¤´éƒ¨ä¸‹æ–¹ -->
  <view class="map-container">
    <map id="runningMap"
         class="running-map"
         latitude="{{mapData.latitude}}"
         longitude="{{mapData.longitude}}"
         scale="{{mapData.scale}}"
         show-location="true"
         polyline="{{mapData.polyline}}"
         show-compass="true"
         enable-rotate="true"
         enable-overlooking="true"
         enable-3D="true"
         enable-zoom="true"
         enable-scroll="true">
      <view class="map-overlay">
        <view class="map-stats">
          <view class="map-stat">
            <text class="stat-value">{{runningData.speedFormatted}}</text>
            <text class="stat-label">é€Ÿåº¦(km/h)</text>
          </view>
          <view class="map-stat">
            <text class="stat-value">{{runningData.cadence}}</text>
            <text class="stat-label">æ­¥é¢‘</text>
          </view>
        </view>
        
        <!-- æ·»åŠ GPSç²¾åº¦ä¿¡æ¯ -->
        <view class="gps-info" wx:if="{{isRunning}}">
          <text class="gps-accuracy">ç²¾åº¦: {{gpsQuality.accuracy}}m</text>
          <text class="gps-rate">æœ‰æ•ˆç‡: {{gpsQuality.accuracyRate}}%</text>
          <text class="fusion-mode" wx:if="{{runningData.usingFusedDistance}}">ä¼ æ„Ÿå™¨èåˆæ¨¡å¼</text>
          <text class="gyro-mode" wx:if="{{runningData.usingGyroCorrection}}">é™€èºä»ªæ–¹å‘ä¿®æ­£</text>
        </view>
      </view>
    </map>
  </view>

  <!-- ä¸»è¦è¿åŠ¨æ•°æ® -->
  <view class="data-overview">
    <view class="progress-rings">
      <!-- è·ç¦»è¿›åº¦ç¯ -->
      <view class="progress-ring">
        <view class="ring-background"></view>
        <view class="ring-progress" style="transform: rotate({{runningData.distance/goals.distance * 360}}deg)"></view>
        <view class="ring-content">
          <text class="ring-value">{{runningData.distanceFormatted}}</text>
          <text class="ring-label">å…¬é‡Œ</text>
        </view>
      </view>
      <!-- æ—¶é—´è¿›åº¦ç¯ -->
      <view class="progress-ring">
        <view class="ring-background"></view>
        <view class="ring-progress" style="transform: rotate({{runningData.duration/(goals.duration*60) * 360}}deg)"></view>
        <view class="ring-content">
          <text class="ring-value">{{runningData.durationFormatted}}</text>
          <text class="ring-label">æ—¶é—´</text>
        </view>
      </view>
      <!-- å¡è·¯é‡Œè¿›åº¦ç¯ -->
      <view class="progress-ring">
        <view class="ring-background"></view>
        <view class="ring-progress" style="transform: rotate({{runningData.calories/goals.calories * 360}}deg)"></view>
        <view class="ring-content">
          <text class="ring-value">{{runningData.calories}}</text>
          <text class="ring-label">åƒå¡</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å®æ—¶æ•°æ®å±•ç¤º -->
  <view class="real-time-data">
    <!-- ä¸»è¦æ•°æ®å¡ç‰‡ -->
    <view class="rt-card main-stats">
      <view class="rt-header">
        <text>å®æ—¶é…é€Ÿ</text>
        <text class="rt-unit">åˆ†é’Ÿ/å…¬é‡Œ</text>
      </view>
      <view class="rt-value {{runningData.pace < 5 ? 'excellent' : runningData.pace < 6 ? 'good' : 'normal'}}">
        {{runningData.paceFormatted}}
      </view>
    </view>

    <!-- æ¬¡è¦æ•°æ®å±•ç¤º -->
    <view class="stats-grid secondary-stats">
      <view class="stat-item">
        <text class="stat-value">{{runningData.cadence || 0}}</text>
        <text class="stat-label">å®æ—¶æ­¥é¢‘</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{runningData.avgCadence || 0}}</text>
        <text class="stat-label">å¹³å‡æ­¥é¢‘</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{runningData.calories || 0}}</text>
        <text class="stat-label">æ¶ˆè€—(kcal)</text>
      </view>
    </view>

    <!-- ç¬¬ä¸‰çº§æ•°æ®å±•ç¤º -->
    <view class="stats-grid tertiary-stats">
      <view class="stat-item">
        <text class="stat-value">{{runningData.strideData.avgLength || '0.00'}}</text>
        <text class="stat-label">æ­¥å¹…(m)</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{sensorData.steps || 0}}</text>
        <text class="stat-label">æ€»æ­¥æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{runningData.avgPaceFormatted || '--\--'}}</text>
        <text class="stat-label">å¹³å‡é…é€Ÿ</text>
      </view>
    </view>
    
    <!-- é…é€Ÿè¯¦æƒ…å¡ç‰‡ -->
    <view class="rt-card pace-details">
      <view class="rt-header">
        <text>é…é€Ÿè¯¦æƒ…</text>
        <text class="rt-unit">æ¯å…¬é‡Œ</text>
      </view>
      <view class="pace-list">
        <block wx:if="{{runningData.kmPaces.length > 0}}">
          <view class="pace-item" wx:for="{{runningData.kmPaces}}" wx:key="km">
            <text class="km-mark">{{item.km}}km</text>
            <text class="km-pace {{item.pace < runningData.avgPace ? 'excellent' : 'normal'}}">{{item.paceFormatted}}</text>
          </view>
        </block>
        <view class="current-km" wx:if="{{runningData.distance > 0}}">
          <text class="km-mark">å½“å‰</text>
          <text class="km-pace">{{runningData.paceFormatted}}</text>
        </view>
      </view>
    </view>

    <!-- å¿ƒç‡åŒºé—´å¡ç‰‡ -->
    <view class="rt-card heart-rate" wx:if="{{runningData.heartRate}}">
      <view class="rt-header">
        <text>å¿ƒç‡åŒºé—´</text>
        <text class="rt-unit">BPM</text>
      </view>
      <view class="heart-rate-zones">
        <view class="zone-item" wx:for="{{runningData.heartRateZones}}" wx:key="index">
          <view class="zone-bar" style="width: {{item.percentage}}%"></view>
          <text class="zone-label">åŒºé—´{{index + 1}}</text>
          <text class="zone-time">{{item.time}}åˆ†é’Ÿ</text>
        </view>
      </view>
    </view>

    <!-- è½¨è¿¹ç»Ÿè®¡å¡ç‰‡ -->
    <view class="rt-card track-stats">
      <view class="rt-header">
        <text>è½¨è¿¹ç»Ÿè®¡</text>
      </view>
      <view class="track-stats-grid">
        <view class="track-stat-item">
          <text class="track-stat-value">{{runningData.totalLocationCount || 0}}</text>
          <text class="track-stat-label">æ€»ç‚¹æ•°</text>
        </view>
        <view class="track-stat-item">
          <text class="track-stat-value">{{runningData.accurateLocationCount || 0}}</text>
          <text class="track-stat-label">æœ‰æ•ˆç‚¹</text>
        </view>
        <view class="track-stat-item">
          <text class="track-stat-value">{{runningData.filteredDistanceKm || '0.00'}}</text>
          <text class="track-stat-label">æœ‰æ•ˆè·ç¦»(km)</text>
        </view>
        <view class="track-stat-item">
          <text class="track-stat-value">{{runningData.avgSpeedFormatted || '0.0'}}</text>
          <text class="track-stat-label">å¹³å‡é€Ÿåº¦(km/h)</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è°ƒè¯•æ•°æ®é¢æ¿ -->
  <view class="debug-panel {{showDebugPanel ? 'expanded' : ''}}">
    <view class="debug-header">
      <text>è°ƒè¯•æ•°æ®</text>
      <view class="debug-toggle" bindtap="toggleDebugPanel">{{showDebugPanel ? 'æ”¶èµ·' : 'å±•å¼€'}}</view>
    </view>
    
    <view class="debug-credits">
      è¿åŠ¨æ•°æ®è°ƒè¯•æ¥è‡ª <text>èƒ–èƒ–èƒ–äº†å°±å¯ä»¥åƒ</text>ã€<text>ç¨‹åºå‘˜ä¸ƒå¹³</text> ç­‰çƒ­å¿ƒè·‘å‹çš„è´¡çŒ®
    </view>

    <view class="debug-content">
      <!-- GPSæ•°æ® -->
      <view class="debug-section">
        <view class="debug-section-title">GPSæ•°æ®</view>
        <view class="debug-item">
          <text class="debug-label">ç²¾åº¦</text>
          <text class="debug-value">{{gpsQuality.accuracy}}ç±³</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">ä¿¡å·è´¨é‡</text>
          <text class="debug-value">{{gpsQuality.signal}}</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">å‡†ç¡®ç‡</text>
          <text class="debug-value">{{gpsQuality.accuracyRate}}%</text>
        </view>
      </view>

      <!-- ä¼ æ„Ÿå™¨èåˆæ•°æ® -->
      <view class="debug-section">
        <view class="debug-section-title">ä¼ æ„Ÿå™¨èåˆ</view>
        <view class="debug-item">
          <text class="debug-label">GPSè·ç¦»</text>
          <text class="debug-value">{{debugInfo.fusion.gpsDistance}}ç±³</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">æ­¥æ•°è·ç¦»</text>
          <text class="debug-value">{{debugInfo.fusion.stepDistance}}ç±³</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">èåˆè·ç¦»</text>
          <text class="debug-value">{{debugInfo.fusion.fusedDistance}}ç±³</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">GPSæƒé‡</text>
          <text class="debug-value">{{debugInfo.fusion.gpsReliability}}</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">æ­¥æ•°æƒé‡</text>
          <text class="debug-value">{{debugInfo.fusion.stepReliability}}</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">ä¼°è®¡æ­¥å¹…</text>
          <text class="debug-value">{{debugInfo.fusion.strideLength}}ç±³/æ­¥</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">æ£€æµ‹ç¯å¢ƒ</text>
          <text class="debug-value">{{debugInfo.fusion.environment}}</text>
        </view>
      </view>

      <!-- è·ç¦»æ•°æ® -->
      <view class="debug-section">
        <view class="debug-section-title">è·ç¦»æ•°æ®</view>
        <view class="debug-item">
          <text class="debug-label">åŸå§‹è·ç¦»</text>
          <text class="debug-value">{{runningData.rawDistance}}ç±³</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">è¿‡æ»¤åè·ç¦»</text>
          <text class="debug-value">{{runningData.filteredDistance}}ç±³</text>
        </view>
      </view>

      <!-- é€Ÿåº¦æ•°æ® -->
      <view class="debug-section">
        <view class="debug-section-title">é€Ÿåº¦æ•°æ®</view>
        <view class="debug-item">
          <text class="debug-label">å½“å‰é€Ÿåº¦</text>
          <text class="debug-value">{{runningData.speedFormatted}}km/h</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">æœ€åæœ‰æ•ˆé€Ÿåº¦</text>
          <text class="debug-value">{{runningData.lastValidSpeed}}m/s</text>
        </view>
      </view>

      <!-- é…é€Ÿæ•°æ® -->
      <view class="debug-section">
        <view class="debug-section-title">é…é€Ÿæ•°æ®</view>
        <view class="debug-item">
          <text class="debug-label">å½“å‰é…é€Ÿ</text>
          <text class="debug-value">{{runningData.paceFormatted}}</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">æœ€åæœ‰æ•ˆé…é€Ÿ</text>
          <text class="debug-value">{{runningData.lastValidPace}}</text>
        </view>
      </view>

      <!-- æ­¥é¢‘æ•°æ® -->
      <view class="debug-section">
        <view class="debug-section-title">æ­¥é¢‘æ•°æ®</view>
        <view class="debug-item">
          <text class="debug-label">å½“å‰æ­¥é¢‘</text>
          <text class="debug-value">{{sensorData.cadence}}æ­¥/åˆ†é’Ÿ</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">æ€»æ­¥æ•°</text>
          <text class="debug-value">{{sensorData.steps}}æ­¥</text>
        </view>
      </view>

      <!-- è¿‡æ»¤å™¨çŠ¶æ€ -->
      <view class="debug-section">
        <view class="debug-section-title">è¿‡æ»¤å™¨çŠ¶æ€</view>
        <view class="debug-item">
          <text class="debug-label">æœ‰æ•ˆç‚¹æ•°</text>
          <text class="debug-value">{{runningData.accurateLocationCount}}/{{runningData.totalLocationCount}}</text>
        </view>
        <view class="debug-item">
          <text class="debug-label">è¿ç»­æ— æ•ˆç‚¹</text>
          <text class="debug-value">{{gpsQuality.consecutiveInvalidCount}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
  <view class="control-area {{isRunning || isPaused ? 'active' : ''}}">
    <!-- å¼€å§‹æŒ‰é’® -->
    <view class="start-button {{isRunning || isPaused ? 'hidden' : ''}}" bindtap="startTraining">
      <view class="button-inner">
        <view class="start-icon"></view>
        <text>å¼€å§‹è¿åŠ¨</text>
      </view>
    </view>

    <!-- è¿åŠ¨ä¸­çš„æ§åˆ¶æŒ‰é’®ç»„ -->
    <view class="control-buttons {{(isRunning || isPaused) ? 'active' : ''}}">
      <!-- æš‚åœ/ç»§ç»­æŒ‰é’® -->
      <view class="control-button pause-resume" bindtap="{{isPaused ? 'resumeTraining' : 'pauseTraining'}}">
        <view class="button-inner {{isPaused ? 'resume' : ''}}">
          <view class="icon"></view>
        </view>
        <text>{{isPaused ? 'ç»§ç»­' : 'æš‚åœ'}}</text>
      </view>

      <!-- ç»“æŸæŒ‰é’® -->
      <view class="control-button end {{isPressingComplete ? 'pressing' : ''}}"
            bindlongpress="handleCompleteLongPress"
            bindtouchend="handleCompleteTouchEnd"
            data-progress="{{completeProgress * 100}}">
        <view class="button-inner">
          <view class="progress-ring" style="--progress: {{completeProgress * 100}}"></view>
          <view class="end-icon"></view>
        </view>
        <text>ç»“æŸ</text>
      </view>
    </view>
  </view>

  <!-- å€’è®¡æ—¶é®ç½© -->
  <view class="countdown-mask {{showCountdown ? 'active' : ''}}" wx:if="{{showCountdown}}">
    <view class="countdown-ring">
      <view class="countdown-progress" style="background: conic-gradient(#FF9800 {{countdownProgress}}%, transparent {{countdownProgress}}%)"></view>
      <text class="countdown-number">{{countdown}}</text>
    </view>
  </view>
</view>